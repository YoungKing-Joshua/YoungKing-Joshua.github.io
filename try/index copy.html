<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Graphing Stuff</title>
		<!-- Include Chart.js library -->
		<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<link ref="stylesheet" href="./style.css" />
	</head>
	<body>
		<style>
			body {
				font-size: 1.25em;
			}

			input[type="file"]::file-selector-button {
				display: none;
			}

			input[type="file"]:: {
				display: none;
			}

			input[type="file"] {
				border: 1px solid black;
				padding: 100px;
				border-radius: 10px;
				transition: 250ms;
				background-color: lightgray;
				cursor: pointer;
			}

			input[type="file"]:hover {
				background-color: gray;
			}

			#startGraphing {
				cursor: pointer;
				width: 150px;
				height: 50px;
				border-radius: 8px;
				border: 1px solid gray;
				margin-left: 50%;
				margin-top: 10px;
			}

			.notClicked {
				transform: translate(calc(-50% - 10px));
				box-shadow: 5px 5px 0px 0px black;
			}

			.clicked {
				box-shadow: 2px 2px 0px 0px black;
				transform: translate(calc(5px - 50% - 10px), 5px);
			}

			#interface {
				margin: auto;
				width: 50%;
				padding: 10px;
				border-radius: 10px;
			}
		</style>
		<!-- Use a canvas element for Chart.js -->
		<canvas id="chartCanvas" style="width: 100%; height: 100%" hidden></canvas>

		<div id="interface">
			<div id="inputInterface" style="text-align: center">
				<label for="docPicker"><h3>Click or drag to upload a .csv file</h3></label>
				<input type="file" id="docPicker" accept=".csv" value="testing things" />
				<input type="button" value="Graph" id="startGraphing" class="notClicked" hidden />
			</div>
			<br />
			<div id="selectionInterface" style="text-align: center" hidden>
				<div style="margin: 10px; display: inline-block; text-align: left; margin-right: 100px">
					<h3>Choose x variable</h3>
					<div id="xAxisVariable"></div>
				</div>
				<div style="margin: 10px; display: inline-block; text-align: left">
					<h3>Choose y variables</h3>
					<div id="graphHeaders"></div>
				</div>
				<div style="clear: both"></div>
			</div>
		</div>
	</body>
</html>

<script>
	const hide = (element) => {
		element.setAttribute("hidden", "");
	};

	const show = (element) => {
		element.removeAttribute("hidden");
	};

	const createChart = (data, labels, title) => {
		const ctx = document.getElementById("chartCanvas").getContext("2d");
		new Chart(ctx, {
			type: "line", // Change this to the desired chart type (e.g., 'bar', 'pie', etc.)
			data: {
				labels: labels,
				datasets: data,
				fill: false,
			},
			options: {
				title: {
					display: true,
					text: title,
				},
			},
		});
	};

	const processData = (rows) => {
		const x = [],
			text = [];

		// Sort the data by the selected x value
		const xVariableElement = [...document.querySelectorAll('input[name="xAxisChoice"]')].find(
			(el) => el.checked
		);
		const xVariable = xVariableElement?.dataset?.header;
		if (xVariable === undefined) {
			alert("You have to select an x-axis for this to work");
			throw new Error("Super smart user is trying to graph without selecting an x value");
		}
		const sortedRows = rows.sort((a, b) => a[xVariable] - b[xVariable]);

		const checkboxes = [...document.querySelectorAll('input[type="checkbox"]')];
		const allYs = {};
		let userChoseAYValue = false;
		checkboxes.forEach((checkbox) => {
			const { checked, name } = checkbox;
			if (checked) {
				allYs[name] = [];
				userChoseAYValue = true;
			}
		});

		if (!userChoseAYValue) {
			alert("You have to select values for the y-axis for this to work");
			throw new Error("Super smart user is trying to graph without selecting any y values");
		}

		// Clear the interface now that we've graphed
		document.getElementById("interface").innerHTML = "";

		sortedRows.forEach((row) => {
			x.push(row[xVariable]);

			Object.keys(allYs).forEach((header) => {
				allYs[header].push(row[header]);
			});

			if (Object.prototype.hasOwnProperty.call(row, "day_time")) {
				const date = new Date(parseFloat(row.day_time));
				text.push(date.toLocaleString());
			} else {
				text.push("");
			}
		});

		const traces = Object.keys(allYs).map((yLabel) => ({
			x,
			y: allYs[yLabel],
			text,
			type: "scatter",
			mode: "markers",
			label: yLabel,
		}));

		return traces;
	};

	const makePlot = (input) => {
		// Remove any padding, scrolling, or margin on the body tag
		document.querySelector("body").style = "margin: 0; padding: 0; overflow: hidden;";
		// Hide the interface and show the graph
		hide(document.getElementById("interface"));
		show(document.getElementById("chartCanvas"));

		d3.csv(input, (rows) => {
			const traces = processData(rows);
			// Extract x and y values from processedData
			const labels = traces[0].x;
			const chartData = traces.map((dataset) => ({
				label: dataset.label,
				data: dataset.y,
			}));

			// Create the Chart.js chart
			createChart(chartData, labels, "Chart Title");
		});
	};

	window.onload = () => {
		show(document.getElementById("interface"));
		const docPicker = document.getElementById("docPicker");
		const graphButton = document.getElementById("startGraphing");

		let clicked = false;
		graphButton.addEventListener("mousedown", (event) => {
			event.target.classList.add("clicked");
			event.target.classList.remove("notClicked");

			clicked = true;
		});

		const resetClick = (event) => {
			if (clicked) {
				event;
				event.target.classList.add("notClicked");
				event.target.classList.remove("clicked");

				// Use the processed data to create the chart
				const fileList = docPicker.files;
				const file = fileList[fileList.length - 1];

				const fileReader = new FileReader();
				fileReader.addEventListener("load", (event) => {
					makePlot(event.target.result);
				});

				fileReader.readAsDataURL(file);

				clicked = false;
			}
		};

		graphButton.addEventListener("mouseup", resetClick);
		graphButton.addEventListener("mouseout", resetClick);

		docPicker.addEventListener("change", (event) => {
			show(document.getElementById("selectionInterface"));
			show(document.getElementById("startGraphing"));
			document.getElementById("startGraphing").style.display = "block";

			const fileList = event.target.files;
			const file = fileList[fileList.length - 1];

			// Read data and display the headers so the user can choose what to display
			const fileReader = new FileReader();
			fileReader.addEventListener("load", (event) => {
				d3.csv(event.target.result, (data) => {
					if (data.length) {
						const headers = Object.keys(data[0]);
						// Display as a checkbox list of which headers to choose
						const headersHTML = headers.map((header) => {
							return `<label for="${header}-header">
                            <input type="checkbox" id="${header}-header" name="${header}"> ${header}
                        </label>`;
						});
						const xAxisVariableHTML = headers.map((header) => {
							return `<label for="${header}-axis">
                            <input type="radio" id="${header}-axis" data-header="${header}" name="xAxisChoice"> ${header}
                        </label>`;
						});

						const graphHeaders = document.getElementById("graphHeaders");
						const xAxisVariable = document.getElementById("xAxisVariable");
						graphHeaders.innerHTML = headersHTML.join("<br/>");
						xAxisVariable.innerHTML = xAxisVariableHTML.join("<br/>");
					}
				});
			});

			fileReader.readAsDataURL(file);
		});
	};
</script>
